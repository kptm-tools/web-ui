<template>
  <Teleport v-if="isMounted" to="#header">
    <div class="q-py-sm">
      <q-btn
        :label="`DOMAIN: ${vulnerabilty.host?.alias}`"
        size="lg"
        flat
        icon="arrow_back"
        @click="
          $router.push({
            name: ROUTES_NAMES.reportsDetail,
            params: { id: reportId }
          })
        "
      ></q-btn>
    </div>
  </Teleport>
  <Teleport v-if="isMounted" to="#aux-sidebar">
    <div
      style="background-color: #313541; height: 100%; overflow-y: auto"
      class="q-pa-md"
    >
      <p class="text-white text-h6">DETAILS</p>

      <q-list class="rounded-borders">
        <q-expansion-item
          expand-separator
          label="DATE"
          dense
          header-style="padding:0;font-weight:600"
          class="text-white vul-container"
        >
          <q-item class="vul-info">
            <span class="vul-title">Published : </span>
            <span class="vul-des"> {{ vulnerabilty.date?.published }}</span>
          </q-item>
          <q-item class="vul-info">
            <span class="vul-title">Last Updated :</span>
            <span class="vul-des"> {{ vulnerabilty.date?.last_updated }}</span>
          </q-item>
        </q-expansion-item>
        <q-expansion-item
          expand-separator
          label="PLUGIN"
          dense
          class="text-white"
          header-style="padding:0;font-weight:600"
        >
          <q-item class="vul-info">
            <span class="vul-title">CPE :</span>
            <span class="vul-des"> {{ vulnerabilty.plugin?.cpe }}</span>
          </q-item>
          <q-item class="vul-info">
            <span class="vul-title">Severity :</span>
            <span class="vul-des"> {{ vulnerabilty.plugin?.severity }}</span>
          </q-item>
          <q-item class="vul-info">
            <span class="vul-title">Version :</span>
            <span class="vul-des"> {{ vulnerabilty.plugin?.version }}</span>
          </q-item>
          <q-item class="vul-info">
            <span class="vul-title">Family :</span>
            <span class="vul-des"> {{ vulnerabilty.plugin?.family }}</span>
          </q-item>
        </q-expansion-item>
        <q-expansion-item
          expand-separator
          label="VPR KEY D."
          dense
          class="text-white"
          header-style="padding:0;font-weight:600"
        >
          <q-item class="vul-info">
            <span class="vul-title">Threat Intensity :</span>
            <span class="vul-des">
              {{ vulnerabilty.vpr_key_d?.threat_intensity }}</span
            >
          </q-item>
          <q-item class="vul-info">
            <span class="vul-title">Exploit Code Maturity :</span>
            <span class="vul-des">
              {{ vulnerabilty.vpr_key_d?.exploit_code_maturity }}</span
            >
          </q-item>
          <q-item class="vul-info">
            <span class="vul-title">Age of Vul :</span>
            <span class="vul-des">
              {{ vulnerabilty.vpr_key_d?.age_of_vuln }}</span
            >
          </q-item>
          <q-item class="vul-info">
            <span class="vul-title">Product Coverage :</span>
            <span class="vul-des">
              {{ vulnerabilty.vpr_key_d?.product_coverage }}</span
            >
          </q-item>
        </q-expansion-item>
        <q-expansion-item
          expand-separator
          label="RISK INFO"
          dense
          class="text-white"
          header-style="padding:0;font-weight:600"
        >
          <q-item class="vul-info">
            <span class="vul-title">Risk Score:</span>
            <span class="vul-des"> {{ vulnerabilty.risk?.risk_score }}</span>
          </q-item>
          <q-item class="vul-info">
            <span class="vul-title">Availability Impact :</span>
            <span class="vul-des">
              {{ vulnerabilty.risk?.availability_impact }}</span
            >
          </q-item>
          <q-item class="vul-info">
            <span class="vul-title">Integrity Impact :</span>
            <span class="vul-des">
              {{ vulnerabilty.risk?.integrity_impact }}</span
            >
          </q-item>
          <q-item class="vul-info">
            <span class="vul-title">CVSS v3 Base :</span>
            <span class="vul-des"> {{ vulnerabilty.risk?.cvss_v3_base }}</span>
          </q-item>
          <q-item class="vul-info">
            <span class="vul-title">CVSS v3 Vector :</span>
            <span class="vul-des">
              {{ vulnerabilty.risk?.cvss_v3_vector }}</span
            >
          </q-item>
        </q-expansion-item>
      </q-list>
    </div>
  </Teleport>
  <vulnerability-card :vul="vulnerabilty" :detail-view="false" />
</template>

<script setup lang="ts">
  import { ScanVulnerability } from 'src/models';
  import { VulnerabilitesService } from 'src/services';
  import { onMounted, Ref, ref } from 'vue';
  import { useRoute } from 'vue-router';
  import { ROUTES_NAMES } from 'src/router/routes-names';
  import VulnerabilityCard from 'src/components/report/VulnerabilityCard.vue';

  const route = useRoute();
  const id = route.params.idvul as string;
  const reportId = route.params.id as string;
  const vulnerabilty: Ref<ScanVulnerability> = ref({} as ScanVulnerability);
  const isMounted = ref(false);

  onMounted(async () => {
    vulnerabilty.value = (
      await VulnerabilitesService.getVulnerabilitesById(id)
    ).data;
    isMounted.value = true;
  });
</script>

<style lang="scss">
  .vul-info {
    padding: 0;
    display: flex;
    flex-direction: column;
    margin: 0.5em 0;
    .vul-title {
      font-weight: 600;
      font-size: 15px;
    }
    .vul-des {
      text-wrap: revert;
      word-break: break-all;
      width: 100%;
      font-weight: 100;
      font-size: 13px;
    }
  }
</style>
